name: Progressive Config Management & Secure Release Pipeline

on:
  push:
    branches:
      - main
      - secure-release-test
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment for deployment'
        required: true
        default: 'staging'
        type: choice
        options:
        - development
        - staging
        - production
      skip_tests:
        description: 'Skip tests (for emergency deployments)'
        required: false
        default: false
        type: boolean

# Step 4: Apply least privilege permissions  
# ðŸ‘‡ Uncomment in Step 4: Secure Authentication
permissions:
  contents: read      # Can read repository
  packages: write     # Can push Docker images
  id-token: write     # Can authenticate with cloud

jobs:
  # Stage 1: Configuration Validation (ALWAYS RUNS FIRST)
  validate-configuration:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Environment Configuration Files
        run: |
          echo "ðŸ” Validating environment configuration files..."
          
          # Make validation script executable
          chmod +x deploy/scripts/validate_env.sh
          
          # Validate all environment files
          echo "Validating development environment..."
          ./deploy/scripts/validate_env.sh deploy/environments/.env.dev
          
          echo "Validating staging environment..."
          ./deploy/scripts/validate_env.sh deploy/environments/.env.staging
          
          echo "Validating production environment..."
          ./deploy/scripts/validate_env.sh deploy/environments/.env.prod
          
          echo "âœ… All environment configurations validated"

      - name: Validate Docker Compose Configuration
        run: |
          echo "ðŸ” Validating Docker Compose configurations..."
          
          # Test each environment configuration
          docker-compose --env-file deploy/environments/.env.dev config --quiet
          echo "âœ… Development config valid"
          
          docker-compose --env-file deploy/environments/.env.staging config --quiet  
          echo "âœ… Staging config valid"
          
          docker-compose --env-file deploy/environments/.env.prod config --quiet
          echo "âœ… Production config valid"
          
          echo "ðŸŽ‰ All Docker Compose configurations validated"

  # Stage 2: Build and Security Scanning
  build-and-test:
    needs: validate-configuration
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install -r src/requirements.txt

      # Step 2: Uncomment to add dependency vulnerability scanning
      # ðŸ‘‡ Uncomment this section in Step 2: Dependency Scanning
      # - name: Install Security Tools
      #   run: |
      #     source venv/bin/activate
      #     pip install pip-audit

      # - name: Scan for Vulnerable Dependencies
      #   run: |
      #     source venv/bin/activate
      #     pip-audit --strict
      #     echo "âœ… No critical vulnerabilities found"

      - name: Build Application (Development Environment)
        run: |
          echo "ðŸ—ï¸ Building application with development configuration..."
          docker-compose --env-file deploy/environments/.env.dev build api
          echo "âœ… Development build completed"

      - name: Run Tests (Development Environment)
        run: |
          echo "ðŸ§ª Running tests in isolated development environment..."
          
          # Start services with development config
          docker-compose --env-file deploy/environments/.env.dev up -d db rabbitmq
          
          # Wait for services to be ready
          echo "Waiting for database to be ready..."
          sleep 10
          
          # Run tests
          source venv/bin/activate
          pytest src/tests/ || echo "âœ… Tests completed"
          
          # Cleanup
          docker-compose --env-file deploy/environments/.env.dev down
          echo "âœ… Development testing completed"

  # Stage 3: Container Build and Security Scanning
  build-container:
    needs: [validate-configuration, build-and-test]
    runs-on: ubuntu-latest
    if: always() && (needs.validate-configuration.result == 'success') && (needs.build-and-test.result == 'success' || inputs.skip_tests)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 3: Uncomment to add SBOM generation
      # ðŸ‘‡ Uncomment this section in Step 3: Software Bill of Materials
      # - name: Generate Software Bill of Materials (SBOM)
      #   run: |
      #     curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
      #     syft . -o cyclonedx-json > sbom.json
      #     echo "ðŸ“‹ SBOM generated with $(jq '.components | length' sbom.json) components"

      # - name: Upload SBOM as Artifact
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: software-bill-of-materials
      #     path: sbom.json

      # - name: Scan SBOM for Vulnerabilities
      #   run: |
      #     curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
      #     grype sbom.json --fail-on high
      #     echo "ðŸ” SBOM vulnerability scan completed"

      - name: Get version from Git commit
        id: get_version
        run: |
          echo "VERSION=${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "Building version: ${GITHUB_SHA::7}"

      # Step 4: Choose your authentication method
      # ðŸš¨ SECURITY ISSUE: Uncomment ONLY ONE of the following login methods:

      # BAD: Hardcoded credentials (Step 1 - shows the problem)
      - name: Log in to Registry (INSECURE - Step 1)
        run: |
          # ðŸš¨ SECURITY ISSUE: Hardcoded password!
          echo "password123" | docker login ghcr.io -u admin --password-stdin
          echo "âš ï¸  Using hardcoded credentials - SECURITY RISK!"

      # GOOD: Uncomment for Step 4: Secure Authentication
      # ðŸ‘‡ Uncomment this section in Step 4 and comment out the above
      # - name: Log in to GitHub Container Registry (SECURE - Step 4)
      #   run: |
      #     echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin
      #     echo "âœ… Using secure GitHub token authentication"

      - name: Build and tag Docker image
        run: |
          docker build -t ghcr.io/${{ github.repository }}/kodekloud-records:${{ env.VERSION }} .
          docker tag ghcr.io/${{ github.repository }}/kodekloud-records:${{ env.VERSION }} ghcr.io/${{ github.repository }}/kodekloud-records:latest
          echo "ðŸ³ Docker image built: kodekloud-records:${{ env.VERSION }}"

      # Step 5: Uncomment to add container vulnerability scanning
      # ðŸ‘‡ Uncomment this section in Step 5: Container Security
      # - name: Scan Container for Vulnerabilities
      #   run: |
      #     echo "ðŸ” Scanning container for vulnerabilities..."
          
      #     # Option A: Scan everything (may find system vulnerabilities)
      #     echo "ðŸ“Š Full vulnerability report:"
          
      #     grype ghcr.io/${{ github.repository }}/kodekloud-records:${{ env.VERSION }} \
      #       --fail-on high \
      #       --only-fixed 
          
      #     echo "âœ… Container vulnerability scan completed"
      #     echo "ðŸ’¡ Note: In production, configure scans based on your risk tolerance"

      - name: Push Docker image
        run: |
          docker push ghcr.io/${{ github.repository }}/kodekloud-records:${{ env.VERSION }}
          docker push ghcr.io/${{ github.repository }}/kodekloud-records:latest
          echo "ðŸ“¦ Images pushed to registry"

  # Stage 4: Deploy to Staging (AUTOMATIC after build succeeds)
  deploy-staging:
    needs: [validate-configuration, build-container]
    runs-on: ubuntu-latest
    environment: staging
    if: always() && (needs.validate-configuration.result == 'success') && (needs.build-container.result == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Environment Promotion Gate
        run: |
          echo "ðŸš¦ Environment Promotion: Development â†’ Staging"
          echo "âœ… Configuration validation: PASSED"
          echo "âœ… Build and tests: PASSED"
          echo "âœ… Container security: PASSED"
          echo "ðŸŸ¢ PROMOTION APPROVED: Deploying to staging"

      - name: Create Staging Environment Configuration
        run: |
          echo "ðŸ”§ Preparing staging deployment configuration..."
          
          # Step 6: Uncomment to use GitHub secrets for staging
          # ðŸ‘‡ Uncomment this section in Step 6: Secure Environment Management
          # cat > deploy/environments/.env.staging.secure << EOF
          # POSTGRES_HOST=staging-db.company.com
          # POSTGRES_DB=kodekloud_records_staging
          # POSTGRES_USER=staging_user
          # POSTGRES_PASSWORD=${{ secrets.STAGING_DB_PASSWORD }}
          # GRAFANA_ADMIN_PASSWORD=${{ secrets.STAGING_GRAFANA_PASSWORD }}
          # DEBUG=false
          # LOG_LEVEL=INFO
          # ENVIRONMENT=staging
          # EOF
          
          echo "âœ… Staging configuration prepared"

      - name: Deploy to Staging
        run: |
          echo "ðŸš€ Deploying to Staging Environment"
          echo "Using configuration: deploy/environments/.env.staging"
          
          # Validate configuration before deployment
          chmod +x deploy/scripts/validate_env.sh
          ./deploy/scripts/validate_env.sh deploy/environments/.env.staging
          
          # In production, you would run:
          # docker-compose --env-file deploy/environments/.env.staging up -d
          
          echo "Environment: Staging"
          echo "Database: $(grep POSTGRES_DB deploy/environments/.env.staging | cut -d'=' -f2)"
          echo "Debug Mode: $(grep DEBUG deploy/environments/.env.staging | cut -d'=' -f2)"
          echo "âœ… Staging deployment completed"

      - name: Staging Integration Tests
        run: |
          echo "ðŸ§ª Running staging integration tests..."
          
          # In production, you would test actual endpoints
          # curl -f http://staging.kodekloud-records.com/health
          # curl -f http://staging.kodekloud-records.com/api/health/database
          
          echo "âœ… Health endpoint: OK"
          echo "âœ… Database connectivity: OK"  
          echo "âœ… API endpoints: OK"
          echo "âœ… Monitoring dashboards: Active"
          echo "ðŸŽ‰ Staging validation successful"

  # Stage 5: Deploy to Production (MANUAL APPROVAL REQUIRED)
  deploy-production:
    needs: [validate-configuration, build-container, deploy-staging]
    runs-on: ubuntu-latest
    environment: production
    if: always() && (needs.validate-configuration.result == 'success') && (needs.build-container.result == 'success') && (needs.deploy-staging.result == 'success') && (github.ref == 'refs/heads/main' || github.event.inputs.environment == 'production')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Production Promotion Gate
        run: |
          echo "ðŸš¦ Environment Promotion: Staging â†’ Production"
          echo "âœ… Configuration validation: PASSED"
          echo "âœ… Build and security scans: PASSED"
          echo "âœ… Staging deployment: PASSED"
          echo "âœ… Staging integration tests: PASSED"
          echo ""
          echo "ðŸ”’ MANUAL APPROVAL REQUIRED FOR PRODUCTION"
          echo "ðŸ‘¤ Approved by: ${{ github.actor }}"
          echo "ðŸ“… Deployment time: $(date)"
          echo "ðŸŸ¢ PRODUCTION DEPLOYMENT AUTHORIZED"

      - name: Create Production Environment Configuration
        run: |
          echo "ðŸ”’ Preparing production deployment configuration..."
          
          # Step 6: Uncomment to use GitHub secrets for production
          # ðŸ‘‡ Uncomment this section in Step 6: Secure Environment Management
          # cat > deploy/environments/.env.prod.secure << EOF
          # POSTGRES_HOST=prod-db-cluster.company.com
          # POSTGRES_DB=kodekloud_records_prod
          # POSTGRES_USER=prod_user
          # POSTGRES_PASSWORD=${{ secrets.PROD_DB_PASSWORD }}
          # GRAFANA_ADMIN_PASSWORD=${{ secrets.PROD_GRAFANA_PASSWORD }}
          # DEBUG=false
          # LOG_LEVEL=WARNING
          # ENVIRONMENT=production
          # PROMETHEUS_RETENTION_TIME=90d
          # EOF
          
          echo "âœ… Production configuration prepared"

      - name: Deploy to Production
        run: |
          echo "ðŸš€ Deploying to Production Environment"
          echo "Using configuration: deploy/environments/.env.prod"
          
          # Validate configuration before deployment
          chmod +x deploy/scripts/validate_env.sh
          ./deploy/scripts/validate_env.sh deploy/environments/.env.prod
          
          # In production, you would run:
          # docker-compose --env-file deploy/environments/.env.prod.secure up -d
          
          echo "Environment: Production"
          echo "Database: $(grep POSTGRES_DB deploy/environments/.env.prod | cut -d'=' -f2)"
          echo "Debug Mode: $(grep DEBUG deploy/environments/.env.prod | cut -d'=' -f2)"
          echo "Log Level: $(grep LOG_LEVEL deploy/environments/.env.prod | cut -d'=' -f2)"
          echo "âœ… Production deployment completed"

      - name: Production Health Check and Monitoring
        run: |
          echo "ðŸ¥ Running comprehensive production health checks..."
          
          # In production, you would test actual endpoints
          # curl -f https://kodekloud-records.com/health
          # curl -f https://kodekloud-records.com/api/health/database
          
          echo "âœ… Application health: OK"
          echo "âœ… Database connection: OK"
          echo "âœ… Load balancer: OK"
          echo "âœ… CDN: OK"
          echo "âœ… Monitoring dashboards: Active"
          echo "âœ… Alerting rules: Configured"
          echo "âœ… Tracing: Active"
          echo "âœ… Logging: Aggregated"
          echo "ðŸŽ‰ Production environment fully operational"

      - name: Post-Deployment Notifications
        run: |
          echo "ðŸ“¢ Sending deployment notifications..."
          echo "âœ… Slack notification: Sent"
          echo "âœ… Email notification: Sent"
          echo "âœ… Monitoring alerts: Updated"
          echo "âœ… Change management: Recorded"
          echo "ðŸ“Š Deployment metrics: Published"

  # Environment Promotion Summary (always runs)
  promotion-summary:
    needs: [validate-configuration, build-and-test, build-container, deploy-staging, deploy-production]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Environment Promotion Report
        run: |
          echo "ðŸš¦ Environment Promotion Pipeline Summary"
          echo "========================================="
          echo ""
          echo "ðŸ”„ Promotion Flow: Development â†’ Staging â†’ Production"
          echo ""
          echo "Stage Status:"
          echo "  âœ… Configuration Validation: ${{ needs.validate-configuration.result }}"
          echo "  âœ… Build & Test (Development): ${{ needs.build-and-test.result }}"
          echo "  âœ… Container Build & Security: ${{ needs.build-container.result }}"
          echo "  âœ… Staging Deployment: ${{ needs.deploy-staging.result }}"
          echo "  ðŸ”’ Production Deployment: ${{ needs.deploy-production.result }}"
          echo ""
          echo "ðŸŽ¯ Environment Promotion Achievements:"
          echo "  âœ… Sequential deployment gates"
          echo "  âœ… Automatic staging promotion"
          echo "  âœ… Manual production approval"
          echo "  âœ… Configuration validation at each stage"
          echo "  âœ… Rollback capability at every level"
          echo ""
          echo "ðŸ”§ Manual Deployment Commands:"
          echo "  â€¢ Development: docker-compose --env-file deploy/environments/.env.dev up"
          echo "  â€¢ Staging: docker-compose --env-file deploy/environments/.env.staging up"
          echo "  â€¢ Production: docker-compose --env-file deploy/environments/.env.prod up"
          echo ""
          echo "ðŸ“š Learn: Progressive Config Management â†’ Environment Promotion â†’ Secure Releases"
